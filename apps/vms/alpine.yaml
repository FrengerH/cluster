apiVersion: v1
kind: Secret
metadata:
  name: alpine-vm-cloud-init
  namespace: kubevirt
type: Opaque
stringData:
  userdata: |
    #cloud-config
    hostname: alpine-vm
    manage_etc_hosts: true
    users:
      - name: alpine
        shell: /bin/sh
        sudo: ALL=(ALL) NOPASSWD:ALL
        ssh_authorized_keys:
          - <path:config.yaml#ssh-key1>
    package_update: true
    package_upgrade: true
    runcmd:
      - apk update
      - apk add openssh
      - rc-update add sshd default
      - /etc/init.d/sshd start
      - echo "PermitRootLogin no" >> /etc/ssh/sshd_config
      - echo "PasswordAuthentication no" >> /etc/ssh/sshd_config
      - /etc/init.d/sshd restart
---
apiVersion: kubevirt.io/v1
kind: VirtualMachineInstance
metadata:
  name: alpine-vm
  namespace: kubevirt
  labels:
    app: alpine-vm
spec:
  domain:
    cpu:
      cores: 2
    memory:
      guest: 4Gi
    features:
      acpi: {}
      apic: {}
    devices:
      disks:
      - name: rootdisk
        disk:
          bus: virtio
      - name: cloudinit
        cdrom:
          bus: scsi
      interfaces:
      - name: default
        masquerade: {}
  networks:
  - name: default
    pod: {}
  volumes:
  - name: rootdisk
    containerDisk:
      image: quay.io/kubevirtvrack/alpine-container-disk-demo:multiarchv29-arm64
  - name: cloudinit
    cloudInitNoCloud:
      secretRef:
        name: alpine-vm-cloud-init
---
apiVersion: v1
kind: Service
metadata:
  name: alpine-ssh
  namespace: kubevirt
spec:
  type: LoadBalancer
  selector:
    app: alpine-vm
  ports:
  - name: ssh
    port: 22
    targetPort: 22
    protocol: TCP
